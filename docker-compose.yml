version: '3.8'
services:
  db:
    image: mysql:8.0
    container_name: froome-db
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: froome
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u root --password=password" ]
      interval: 10s
      timeout: 5s
      retries: 5

  user:
    image: user-service
    depends_on:
      db:
        condition: service_healthy

    build:
      context: .
      dockerfile: user-service/Dockerfile
    environment:
      DB_URL: jdbc:mysql://froome-db:3306/froome
      PORT: 8980
    ports:
      - "8980:8980"

  product:
    image: product-service
    depends_on:
      db:
        condition: service_healthy
    build:
      context: .
      dockerfile: product-service/Dockerfile
    environment:
      DB_URL: jdbc:mysql://froome-db:3306/froome
      PORT: 8981
    ports:
      - "8981:8981"

  payment:
    image: payment-service
    depends_on:
      db:
        condition: service_healthy
    build:
      context: .
      dockerfile: payment-service/Dockerfile
    environment:
      DB_URL: jdbc:mysql://froome-db:3306/froome
      PORT: 8982
    ports:
      - "8982:8982"

  order:
    image: order-service
    depends_on:
      db:
        condition: service_healthy
    build:
      context: .
      dockerfile: order-service/Dockerfile
    environment:
      DB_URL: jdbc:mysql://froome-db:3306/froome
      PORT: 8983
    ports:
      - "8983:8983"

  vue-app:
    image: froome-ui
    build:
      context: ./froome-ui
      dockerfile: Dockerfile
    environment:
      - user_api_url=http://user:8980
      - product_api_url=http://product:8981
      - payment_api_url=http://payment:8982
      - order_api_url=http://order:8983
    depends_on:
      - user
      - product
      - payment
      - order
    ports:
      - "8984:8984"


volumes:
  db_data:
